#include <SoftwareSerial.h>
#include "RoboClaw.h"

// Hardware Setup
SoftwareSerial roboclawSerial(10, 11); // RX (Pin 10), TX (Pin 11)
RoboClaw roboclaw(&roboclawSerial, 10000);

#define ADDR 0x80

// --- PID CONSTANTS ---
// You may need to adjust these for your specific motors
// Kp, Ki, Kd, MaxQPPS (Quad Pulses Per Second)
float Kp = .5;
float Ki = 0.1;
float Kd = 0.0;
uint32_t qpps = 10000000; // This is the max speed of your motor in encoder counts

void setup() {
  Serial.begin(115200);        // USB to Jetson
  roboclaw.begin(38400);       // To RoboClaw
  
  // Set PID Constants on the RoboClaw hardware
  roboclaw.SetM1VelocityPID(ADDR, Kp, Ki, Kd, qpps);
  roboclaw.SetM2VelocityPID(ADDR, Kp, Ki, Kd, qpps);
  
  pinMode(LED_BUILTIN, OUTPUT);
  Serial.println("PID_CONTROLLER_READY");
}

void loop() {
  // 1. Handle incoming commands from Jetson
  if (Serial.available() > 0) {
    String data = Serial.readStringUntil('\n');
    data.trim();
    int commaIndex = data.indexOf(',');
    if (commaIndex != -1) {
      long speedL = data.substring(0, commaIndex).toInt();
      long speedR = data.substring(commaIndex + 1).toInt();
      
      // We still use Speed commands for PID control
      roboclaw.SpeedM1(ADDR, speedL); // Keeping your reversed logic
      roboclaw.SpeedM2(ADDR, speedR);
    }
  }

  // 2. CONSTANTLY report status back to Python
  static uint32_t lastReport = 0;
  if (millis() - lastReport > 50) { // Report every 50ms (20Hz)
    uint8_t status1, status2;
    bool valid1, valid2;
    
    // Read Total Distance (Cumulative Pulses)
    int32_t encL = roboclaw.ReadEncM1(ADDR, &status1, &valid1);
    int32_t encR = roboclaw.ReadEncM2(ADDR, &status2, &valid2);
    
    // Read Current Speed (Pulses Per Second)
    int32_t speedL = roboclaw.ReadSpeedM1(ADDR, &status1, &valid1);
    int32_t speedR = roboclaw.ReadSpeedM2(ADDR, &status2, &valid2);

    if (valid1 && valid2) {
      // Format: TELEMETRY:encL,encR,speedL,speedR
      Serial.print("TELEMETRY:");
      Serial.print(encL); Serial.print(",");
      Serial.print(encR); Serial.print(",");
      Serial.print(speedL); Serial.print(",");
      Serial.println(speedR);
    }
    lastReport = millis();
  }
}
